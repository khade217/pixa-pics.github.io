(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{659:function(t,e,_){"use strict";var n,s,o=_(625),r=_(619),i=(0,r.SIMDopeCreateConfAdd)({create:{new_of:!0},properties:{uint32:!0,laba:!0,rgbaon4bits:!0,rgbaon6bits:!0,rgbaon8bits:!0,rgbaon12bits:!0,rgbaon16bits:!0,skin:!0},methods:{simplify:!0,get_new_element:!0,get_use_element:!0,set_tail:!0,is_dark:!0,blend_first_with:!0,blend_first_with_tails:!0,blend_all:!0,euclidean_match_with:!0,manhattan_match_with:!0,cie76_match_with:!0,copy:!0}}),l=Math.fround,p=l(1),c=l(.777);const{simdops:u,Color:h,Colors:a}=(0,r.SIMDopeCreate)(i),{minus_int:f,int_not_equal:g,plus_int:x,plus_uint:d,minus_uint:y,multiply_int:w,multiply_uint:b,multiply_uint_4:m,divide_uint:P,clamp_uint8:j,clamp_uint32:O,int_equal:k,uint_less:v,int_less:A,int_greater_equal:U,uint_not_equal:M,uint_less_equal:C,min_uint:q}=u;Object.defineProperty((n=function(t){if(t=t||{},!(this instanceof n))return new n(t);t.pxl_colors=t.pxl_colors||new Uint32Array(0),t.pxls=t.pxls||new Uint32Array(0),this.new_pxls_="buffer"in t.pxls?new Uint32Array(t.pxls.buffer):Uint32Array.from(t.pxls),this.new_pxl_colors_="buffer"in t.pxl_colors?new a(t.pxl_colors.buffer):new a(Uint32Array.from(t.pxl_colors).buffer);var e=0|this.new_pxl_colors_.length;this.new_pxl_colors_is_skin_mask_=new o.SetFixed(0|e),this.set_new_pxl_skin_mask(),this.best_color_number_=t.number_of_color,this.max_cluster_=e>65536?65537:e>16384?4097:e>8192?257:e>512?17:1,this.index_clusters_=Array(this.max_cluster_),this.length_clusters_=new Uint32Array(this.max_cluster_),this.pxl_colors_usage_=new Uint32Array(e),this.all_index_clusters_=new Uint32Array(e),this.clean_pxl_colors_=new Uint32Array(e),this.clean_pxl_colors_lookup_={},this.is_skin_ops_=0,this.match_ops_=0,this.blend_ops_=0,this.remove_duplicate_ops_=0,this.simplify_ops_=0,this.classify_on_x_bits_ops_=0}).prototype,"set_is_skin_ops",{get:function(){return function(t){this.is_skin_ops_=(0|t)>>>0}}}),Object.defineProperty(n.prototype,"set_match_ops",{get:function(){return function(t){this.match_ops_=(0|t)>>>0}}}),Object.defineProperty(n.prototype,"set_blend_ops",{get:function(){return function(t){this.blend_ops_=(0|t)>>>0}}}),Object.defineProperty(n.prototype,"set_remove_duplicate_ops",{get:function(){return function(t){this.remove_duplicate_ops_=(0|t)>>>0}}}),Object.defineProperty(n.prototype,"set_simplify_ops",{get:function(){return function(t){this.simplify_ops_=t}}}),Object.defineProperty(n.prototype,"set_classify_on_x_bits_ops",{get:function(){return function(t){this.classify_on_x_bits_ops_=t}}}),Object.defineProperty(n.prototype,"get_is_skin_ops",{get:function(){return function(){return 0|this.is_skin_ops_}}}),Object.defineProperty(n.prototype,"get_match_ops",{get:function(){return function(){return 0|this.match_ops_}}}),Object.defineProperty(n.prototype,"get_blend_ops",{get:function(){return function(){return 0|this.blend_ops_}}}),Object.defineProperty(n.prototype,"get_remove_duplicate_ops",{get:function(){return function(){return 0|this.remove_duplicate_ops_}}}),Object.defineProperty(n.prototype,"get_simplify_ops",{get:function(){return function(){return this.simplify_ops_}}}),Object.defineProperty(n.prototype,"get_classify_on_x_bits_ops",{get:function(){return function(){return this.classify_on_x_bits_ops_}}}),Object.defineProperty(n.prototype,"reset_deduplicate",{get:function(){return function(t){this.clean_pxl_colors_lookup_={},this.pxl_colors_usage_.fill(0,0,0|t),this.clean_pxl_colors_.fill(0,0,0|t)}}}),Object.defineProperty(n.prototype,"index_of_color_within_cleaned",{get:function(){return function(t){return(0|this.clean_pxl_colors_lookup_[(0|t)>>>0])-1|0}}}),Object.defineProperty(n.prototype,"set_cleaned_pxl_colors",{get:function(){return function(t,e){this.clean_pxl_colors_[(0|t)>>>0]=(0|e)>>>0,this.clean_pxl_colors_lookup_[(0|e)>>>0]=(t+1|0)>>>0}}}),Object.defineProperty(n.prototype,"increase_color_usage",{get:function(){return function(t){this.pxl_colors_usage_[(0|t)>>>0]=(this.pxl_colors_usage_[(0|t)>>>0]+1|0)>>>0}}}),Object.defineProperty(n.prototype,"set_new_pxls",{get:function(){return function(t,e){this.new_pxls_[(0|t)>>>0]=(0|e)>>>0}}}),Object.defineProperty(n.prototype,"set_new_pxl_colors",{get:function(){return function(t){this.new_pxl_colors_=new a(this.clean_pxl_colors_.buffer.slice(0,m(0|t))),this.set_new_pxl_skin_mask()}}}),Object.defineProperty(n.prototype,"set_new_pxl_skin_mask",{get:function(){return function(){var t=new h(new ArrayBuffer(4)),e=0|this.new_pxl_colors_.length,_=0;for(this.new_pxl_colors_is_skin_mask_=new o.SetFixed(0|e);(0|_)<(0|e);_=_+1|0)this.new_pxl_colors_.get_use_element(0|_,t).skin&&this.new_pxl_colors_is_skin_mask_.add(0|_);this.set_is_skin_ops(this.get_is_skin_ops()+_|0)}}}),Object.defineProperty(n.prototype,"get_a_new_pxl_color_from_pxl_index",{get:function(){return function(t){return 4294967295&this.new_pxl_colors_.buffer_getUint32(this.new_pxls_[0|t])}}}),Object.defineProperty(n.prototype,"reset_cluster",{get:function(){return function(){this.max_cluster_=this.new_pxl_colors_.length>65536?65537:this.new_pxl_colors_.length>16384?4097:this.new_pxl_colors_.length>8192?257:this.new_pxl_colors_.length>512?17:1,this.length_clusters_.fill(0,0,0|this.max_cluster);for(var t=0;(0|t)<(0|this.max_cluster);t=(t+1|0)>>>0)this.index_clusters_[0|t]=[]}}}),Object.defineProperty(n.prototype,"add_in_indexes_cluster",{get:function(){return function(t,e){this.index_clusters_[(0|t)>>>0].push((0|e)>>>0)}}}),Object.defineProperty(n.prototype,"set_all_cluster_indexes",{get:function(){return function(){for(var t=0,e=0;(0|t)<(0|this.max_cluster);t=(t+1|0)>>>0)this.all_index_clusters_.set(this.index_clusters_[(0|t)>>>0],(0|e)>>>0),e=(e+this.get_length_in_index_clusters(0|t)|0)>>>0}}}),Object.defineProperty(n.prototype,"get_length_in_index_clusters",{get:function(){return function(t){return(0|this.index_clusters_[(0|t)>>>0].length)>>>0}}}),Object.defineProperty(n.prototype,"get_in_cluster_lengths",{get:function(){return function(t){return(0|this.length_clusters_[(0|t)>>>0])>>>0}}}),Object.defineProperty(n.prototype,"get_an_index_in_clusters",{get:function(){return function(t){return(0|this.all_index_clusters_[0|t])>>>0}}}),Object.defineProperty(n.prototype,"get_a_color_usage",{get:function(){return function(t){return(0|this.pxl_colors_usage_[0|t])>>>0}}}),Object.defineProperty(n.prototype,"set_a_color_usage",{get:function(){return function(t,e){return this.pxl_colors_usage_[0|t]=(0|e)>>>0}}}),Object.defineProperty(n.prototype,"get_a_color_usage_percent",{get:function(){return function(t){return this.pxl_colors_usage_[0|t]/this.new_pxls_.length}}}),Object.defineProperty(n.prototype,"get_average_color_usage_percent",{get:function(){return function(t,e){var _,n,s;for(e=0|((e|=0)<(t|=0)?this.pxl_colors_usage_.length:e),_=0,n=0,s=0,n=0|t;(0|n)<(0|e);n=(n+1|0)>>>0)s=(0|this.get_an_index_in_clusters((0|n)>>>0))>>>0,_+=this.pxl_colors_usage_[0|s]/this.new_pxls_.length;return _/(e-t|0)}}}),Object.defineProperty(n.prototype,"get_a_new_pxl_color",{get:function(){return function(t){return this.new_pxl_colors_.get_new_element(0|t)}}}),Object.defineProperty(n.prototype,"is_pxl_color_skin",{get:function(){return function(t){return this.new_pxl_colors_is_skin_mask_.has(0|t)}}}),Object.defineProperty(n.prototype,"max_cluster",{get:function(){return 0|this.max_cluster_}}),Object.defineProperty(n.prototype,"new_pxls_length",{get:function(){return 0|this.new_pxls_.length}}),Object.defineProperty(n.prototype,"new_pxl_colors_length",{get:function(){return 0|this.new_pxl_colors_.length}}),Object.defineProperty(n.prototype,"best_color_number",{get:function(){return 0|this.best_color_number_}}),Object.defineProperty(n.prototype,"get_data",{get:function(){return function(){return Array.of(this.new_pxls_,this.new_pxl_colors_.subarray_uint32(0,this.new_pxl_colors_.length),{deduplicate:this.get_remove_duplicate_ops(),simplify:this.get_simplify_ops(),classify:this.get_classify_on_x_bits_ops(),skin:this.get_is_skin_ops(),blend:this.get_blend_ops(),match:this.get_match_ops()})}}}),n.prototype.output=function(t){var e,_;return t=t||"heap",e=this.get_data(),"heap"==t?((_=new Uint32Array(2+e[0].length+e[1].length))[0]=0|e[0].length,_[1]=0|e[1].length,_.set(e[0],2),_.set(e[1],2+e[0].length),_.buffer):e},n.prototype.deduplicate=function(){var t,e,_,n,s;for(this.set_remove_duplicate_ops(this.get_remove_duplicate_ops()+1|0),this.reset_deduplicate(0|this.new_pxl_colors_length),t=0,e=0,_=0,n=0,s=0|this.new_pxls_length;(0|n)<(0|s);n=(n+1|0)>>>0)e=0|this.get_a_new_pxl_color_from_pxl_index(0|n),-1==(0|(_=0|this.index_of_color_within_cleaned(0|e)))&&(this.set_cleaned_pxl_colors(0|t,0|e),_=0|t,t=t+1|0),this.increase_color_usage(0|_),this.set_new_pxls(0|n,0|_);this.set_new_pxl_colors(t)},n.prototype.clusterize=function(){this.reset_cluster();var t=0;if(65537===this.max_cluster)for(;(0|t)<(0|this.new_pxl_colors_length);t=(t+1|0)>>>0)this.add_in_indexes_cluster((0|this.get_a_new_pxl_color((0|t)>>>0).rgbaon16bits)>>>0,(0|t)>>>0);else if(4097===this.max_cluster)for(;(0|t)<(0|this.new_pxl_colors_length);t=(t+1|0)>>>0)this.add_in_indexes_cluster((0|this.get_a_new_pxl_color((0|t)>>>0).rgbaon12bits)>>>0,(0|t)>>>0);else if(257===this.max_cluster)for(;(0|t)<(0|this.new_pxl_colors_length);t=(t+1|0)>>>0)this.add_in_indexes_cluster((0|this.get_a_new_pxl_color((0|t)>>>0).rgbaon8bits)>>>0,(0|t)>>>0);else if(17===this.max_cluster)for(;(0|t)<(0|this.new_pxl_colors_length);t=(t+1|0)>>>0)this.add_in_indexes_cluster((0|this.get_a_new_pxl_color((0|t)>>>0).rgbaon4bits)>>>0,(0|t)>>>0);else for(;(0|t)<(0|this.new_pxl_colors_length);t=(t+1|0)>>>0)this.add_in_indexes_cluster(0,(0|t)>>>0);this.max_cluster>1&&this.set_classify_on_x_bits_ops(this.get_classify_on_x_bits_ops()+this.new_pxl_colors_length),this.set_all_cluster_indexes()},n.prototype.process_threshold=function(t){var e,_,n,s,o,r,i,u,a,f,g,x,d,y,w,b,m,P,j,O,k,v,A,U,M;for(e=function(t,e){return l((Math.pow(t,1.5)-t)/900)}(t=(0|t)>>>0),_=!1,n=[],s=[],o=0,r=0,a=!1,f=!1,g=0,x=0,d=0,y=0,w=0,b=0,O=0,k=0,v=0,A=0,U=0,M=0,j=l((m=e)*c),P=l(m*p);(0|U)<(0|this.max_cluster);U=(U+1|0)>>>0){for(r=(o+((0|this.get_length_in_index_clusters(0|U))>>>0)|0)>>>0,w=this.get_average_color_usage_percent(0|o,0|r),v=0|o;(0|v)<(0|r);v=(v+1|0)>>>0){if(O=(0|this.get_an_index_in_clusters((0|v)>>>0))>>>0,i=this.get_a_new_pxl_color((0|O)>>>0),a=this.is_pxl_color_skin((0|O)>>>0),(0|(g=(0|this.get_a_color_usage((0|O)>>>0))>>>0))>0)for(n=[],A=0|o;(0|A)<(0|r);A=(A+1|0)>>>0)k=(0|this.get_an_index_in_clusters((0|A)>>>0))>>>0,u=this.get_a_new_pxl_color((0|k)>>>0),f=this.is_pxl_color_skin((0|k)>>>0),0!=(0|(x=(0|this.get_a_color_usage((0|k)>>>0))>>>0))&&(0|O)!=(0|k)&&(0|a)==(0|f)&&(d=this.get_a_color_usage_percent((0|O)>>>0)/w,y=this.get_a_color_usage_percent((0|k)>>>0)/w,M=l((M=a&&f?j:a||f?P:m)*(3*Math.abs(d-y)+5*(2-(d+y))+8)/16),i.cie76_match_with(u,M)&&(b=l(x/g),_=!0,this.set_a_color_usage(0|k,0),n.push(u),s.push(b)));(0|n.length)>0&&(h.blend_all(i,n,s),n=[],s=[])}o=0|r}return _},n.prototype.round=function(){var t,e;if(this.new_pxl_colors_length>1024){for(t=0|(this.new_pxl_colors_length>32768?24:this.new_pxl_colors_length>32768?20:this.new_pxl_colors_length>16384?16:this.new_pxl_colors_length>8192?12:this.new_pxl_colors_length>2048?8:this.new_pxl_colors_length>1024?4:1),e=0;(0|e)<(0|this.new_pxl_colors_length);e=(e+1|0)>>>0)this.get_a_new_pxl_color((0|e)>>>0).simplify(t);this.set_simplify_ops(this.get_simplify_ops()+this.new_pxl_colors_length)}},n.prototype.init=function(){return this.round(),this.deduplicate(),this.clusterize(),this},n.prototype.run=function(){for(var t=0|(this.new_pxl_colors_length>6e4?12:this.new_pxl_colors_length>32e3?8:this.new_pxl_colors_length>16e3?4:this.new_pxl_colors_length>8192?3:this.new_pxl_colors_length>4096?2:1);this.new_pxl_colors_length>this.best_color_number;)this.process_threshold(0|t)&&(this.deduplicate(),this.clusterize()),t=t+(this.new_pxl_colors_length>6e4?12:this.new_pxl_colors_length>32e3?8:this.new_pxl_colors_length>16e3?4:this.new_pxl_colors_length>8192?3:this.new_pxl_colors_length>4096?2:1)|0;return this},s=function(t,e){return new Promise((function(_){var s,o,r,i,l,p,c,u,h=new Uint32Array(t.data.buffer),a=Uint32Array.from(new Set(h)),f={},g=a.length,x=new Uint32Array(h.length);for(s=0,o=0|g;(0|s)<(0|o);s=(s+1|0)>>>0)f[a[0|s]]=(0|s)>>>0;for(s=0,o=0|h.length;(0|s)<(0|o);s=(s+1|0)>>>0)x[0|s]=(0|f[h[0|s]])>>>0;for(r=Date.now(),i=n({pxls:x,pxl_colors:a,number_of_color:"auto"===e?g/1.314|0:parseFloat(e)<1?g-Math.ceil(g/25):e,width:t.width,height:t.height}).init().run().output("split"),l=Date.now(),console.log(i[2]),c=0|(p=i[0]).length,p.length,u=i[1],s=0;(0|s)<(0|c);s=(s+1|0)>>>0)h[0|s]=(0|u[(0|p[0|s])>>>0])>>>0;_([t=new ImageData(new Uint8ClampedArray(h.buffer),t.width,t.height),p,u,g-u.length,u.length,l-r])}))},t.exports={QuantiMatGlobal:s,QuantiMat:n}}}]);